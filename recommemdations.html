<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcasts from your daughter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
        }
        .page-header {
            text-align: center;
            padding: 20px;
        }
        .sort-options {
            text-align: center;
            margin: 20px 0;
        }
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .product-card {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            padding: 15px;
            transition: transform 0.3s;
        }
        .product-card:hover {
            transform: scale(1.05);
        }
        .product-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .product-card h3 {
            font-size: 1.2rem;
            color: #333;
        }
        .product-card p {
            font-size: 1rem;
            color: #777;
        }
        .product-card .time {
            font-size: 1.5rem;
            font-weight: bold;
            color: #27ae60;
            margin-top: 10px;
        }
        .listen-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        .listen-btn:hover {
            background-color: #2ecc71;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="page-header">
        <h1>Welcome to your podcast recommendations, Sandeep</h1>
        <p>Browse through Ashima's recommendations for you!</p>
    </div>

    <!-- Sort Options -->
    <div class="sort-options">
        <label for="sortSelect">Sort by: </label>
        <select id="sortSelect" onchange="sortProducts()">
            <option value="time-asc">Time: Low to High</option>
            <option value="time-desc">Time: High to Low</option>
            <option value="title-asc">Show Name: A to Z</option>
            <option value="title-desc">Show Name: Z to A</option>
        </select>
    </div>

    <div class="product-list" id="product-list">
        <!-- Product cards will be inserted here by JavaScript -->
    </div>
</div>

<script>
    let products = [];
    let episodes = [];

    function getQueryParameter(password) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(password);
    }

    const clientId =  getQueryParameter('password').slice(0, 32) 
    const clientSecret = getQueryParameter('password').slice(-32) ; 

    
    async function getAccessToken() {
      const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          Authorization: `Basic ${btoa(`${clientId}:${clientSecret}`)}`
        },
        body: 'grant_type=client_credentials'
      });

      if (!response.ok) {
        throw new Error('Failed to fetch access token');
      }

      const data = await response.json();
      return data.access_token;
    }

    

    function readCSV() {
        episodes = [];
        products = [];
        fetch('episodes.txt')
        .then(response => {
                // Check if the request was successful
                if (!response.ok) {
                    throw new Error('Failed to fetch the CSV file');
                }
                return response.text(); // Read the CSV file as text
            })
        .then(csvData => {
                const rows = csvData.split('\n');
                item = rows.map(row => row.split(','));

                rows.forEach(row => {
                    let episode = {}
                    const parts = row.split(',')[0].split('/');
                    episode.id = parts[parts.length - 1]
                    episode.ashimaDescription = row.split(',')[1]
                    episodes.push(episode)
                });

                
            })
            .catch(error => {
                console.error('Error reading the CSV file:', error);
            });
    }

    async function fetchEpisodeDetails(id, token) {
      const response = await fetch(`https://api.spotify.com/v1/episodes/${id}`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch episode details for ID ${id}`);
      }

      const data = await response.json();
      return data;
    }

    async function displayEpisodes() {
      try {
        const token = await getAccessToken();
        for (let i = 0; i < episodes.length; i++) {
          try {
            const product = {}
            const details = await fetchEpisodeDetails(episodes[i].id, token);
            const durationMinutes = (details.duration_ms / 60000).toFixed(0);
            product.title = details.name
            product.durationMinutes = durationMinutes
            product.image = details.images[0]?.url
            product.showName = details.show.name
            product.description = episodes[i].ashimaDescription
            product.id = episodes[i].id
            products.push(product)
           } catch (error) {
            console.error(error);
          }

        }
      } catch (error) {
        console.error('Error fetching access token:', error);
        alert('Failed to fetch access token. Please check your Client ID and Client Secret.');
      }
    }


    // Function to generate product cards dynamically
    function generateProductCards() {
        let productListData = ''
        const productList = document.getElementById('product-list');
        productList.innerHTML = ''; 
        products.forEach(product => {
            const productCard = `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.title}">
                    <h3>${product.title}</h3>
                    <p>${product.showName}</p>
                    <p>${product.description}</p>
                    <p class="time">${product.durationMinutes} minutes</p>
                    <button class="listen-btn">Listen Here</button>
                </div>
            `;
            // Append the generated HTML to the product-list div
            productListData += productCard;
        });
        productList.innerHTML = productListData;
    }

    // Function to sort products based on selected criteria
    function sortProducts() {
        const sortValue = document.getElementById('sortSelect').value;

        // Sorting logic
        if (sortValue === 'time-asc') {
            products.sort((a, b) => a.durationMinutes - b.durationMinutes);
        } else if (sortValue === 'time-desc') {
            products.sort((a, b) => b.durationMinutes - a.durationMinutes);
        } else if (sortValue === 'title-asc') {
            products.sort((a, b) => a.showName.localeCompare(b.showName));
        } else if (sortValue === 'title-desc') {
            products.sort((a, b) => b.showName.localeCompare(a.showName));
        }

        // Regenerate the product list after sorting
        generateProductCards();
    }

    // Call the function to generate the cards when the page loads
    async function initializePage() {
        await readCSV();
        await displayEpisodes();  // Wait for the episode details to be fetched
        generateProductCards();   // Generate the product cards after the data is ready
    }

    // Initialize the page on load
    initializePage();
</script>

</body>
</html>


